<?php
/**
 * LearnDash Video Support for Custom Templates
 * 
 * Adds video support to custom LearnDash lesson templates that don't use
 * the default LearnDash template system.
 * 
 * @package LearnDash_Video_Support
 * @version 1.0.0
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

class LearnDash_Custom_Video_Support {
    
    /**
     * Initialize the video support
     */
    public function __construct() {
        add_action('init', array($this, 'init'));
    }
    
    /**
     * Initialize hooks
     */
    public function init() {
        // Add video support to lesson content
        add_filter('the_content', array($this, 'add_video_to_lesson_content'), 10);
        
        // Enqueue video assets
        add_action('wp_enqueue_scripts', array($this, 'enqueue_video_assets'));
        
        // Add video progression JavaScript
        add_action('wp_footer', array($this, 'add_video_scripts'));
        
        // Debug logging
        if (defined('WP_DEBUG') && WP_DEBUG) {
            add_action('wp_footer', array($this, 'debug_video_info'));
        }
    }
    
    /**
     * Add video content to lesson/topic content
     */
    public function add_video_to_lesson_content($content) {
        global $post;
        
        // Only process on single lesson/topic pages
        if (!is_singular(array('sfwd-lessons', 'sfwd-topic')) || !$post) {
            return $content;
        }
        
        // Check if LearnDash video is enabled
        if (!defined('LEARNDASH_LESSON_VIDEO') || !LEARNDASH_LESSON_VIDEO) {
            return $content;
        }
        
        // Get the lesson/topic settings
        $step_settings = array();
        if ($post->post_type === 'sfwd-lessons') {
            $step_settings = learndash_get_setting($post);
        } elseif ($post->post_type === 'sfwd-topic') {
            $step_settings = learndash_get_setting($post);
        }
        
        // Check if video is enabled and has URL
        if (empty($step_settings['lesson_video_enabled']) || 
            $step_settings['lesson_video_enabled'] !== 'on' ||
            empty($step_settings['lesson_video_url'])) {
            return $content;
        }
        
        // Get video instance and add video to content
        if (class_exists('Learndash_Course_Video')) {
            $ld_course_videos = Learndash_Course_Video::get_instance();
            $content = $ld_course_videos->add_video_to_content($content, $post, $step_settings);
        }
        
        return $content;
    }
    
    /**
     * Enqueue video assets
     */
    public function enqueue_video_assets() {
        if (!is_singular(array('sfwd-lessons', 'sfwd-topic'))) {
            return;
        }
        
        global $post;
        
        // Get lesson/topic settings
        $step_settings = learndash_get_setting($post);
        
        // Check if video is enabled
        if (empty($step_settings['lesson_video_enabled']) || 
            $step_settings['lesson_video_enabled'] !== 'on' ||
            empty($step_settings['lesson_video_url'])) {
            return;
        }
        
        // Enqueue LearnDash video CSS
        $video_css_file = SFWD_LMS::get_template('learndash_lesson_video.css', null, null, true);
        if ($video_css_file) {
            wp_enqueue_style(
                'learndash_lesson_video', 
                learndash_template_url_from_path($video_css_file), 
                array(), 
                LEARNDASH_SCRIPT_VERSION_TOKEN
            );
        }
        
        // Enqueue video progression script
        wp_enqueue_script(
            'learndash_video_script',
            LEARNDASH_LMS_PLUGIN_URL . 'assets/js/learndash_video_script.min.js',
            array('jquery'),
            LEARNDASH_SCRIPT_VERSION_TOKEN,
            true
        );
    }
    
    /**
     * Add video progression scripts to footer
     */
    public function add_video_scripts() {
        if (!is_singular(array('sfwd-lessons', 'sfwd-topic'))) {
            return;
        }
        
        global $post;
        
        // Get lesson/topic settings
        $step_settings = learndash_get_setting($post);
        
        // Check if video is enabled
        if (empty($step_settings['lesson_video_enabled']) || 
            $step_settings['lesson_video_enabled'] !== 'on' ||
            empty($step_settings['lesson_video_url'])) {
            return;
        }
        
        // Get video data from LearnDash
        if (class_exists('Learndash_Course_Video')) {
            $ld_course_videos = Learndash_Course_Video::get_instance();
            
            // Get course ID
            $course_id = learndash_get_course_id($post);
            $user_id = get_current_user_id();
            
            // Initialize video for this step
            $video_data = $ld_course_videos->init_video_data($post->ID, $course_id, $user_id);
            
            if (!empty($video_data)) {
                ?>
                <script type="text/javascript">
                /* <![CDATA[ */
                var learndash_video_data = <?php echo json_encode($video_data); ?>;
                /* ]]> */
                </script>
                <?php
            }
        }
    }
    
    /**
     * Debug video information
     */
    public function debug_video_info() {
        if (!is_singular(array('sfwd-lessons', 'sfwd-topic'))) {
            return;
        }
        
        global $post;
        
        $step_settings = learndash_get_setting($post);
        
        echo '<!-- LearnDash Video Debug Info -->';
        echo '<!-- Post Type: ' . esc_html($post->post_type) . ' -->';
        echo '<!-- Post ID: ' . esc_html($post->ID) . ' -->';
        echo '<!-- Video Enabled: ' . (isset($step_settings['lesson_video_enabled']) ? esc_html($step_settings['lesson_video_enabled']) : 'not set') . ' -->';
        echo '<!-- Video URL: ' . (isset($step_settings['lesson_video_url']) ? esc_html($step_settings['lesson_video_url']) : 'not set') . ' -->';
        echo '<!-- LEARNDASH_LESSON_VIDEO: ' . (defined('LEARNDASH_LESSON_VIDEO') && LEARNDASH_LESSON_VIDEO ? 'enabled' : 'disabled') . ' -->';
        echo '<!-- End LearnDash Video Debug -->';
    }
}

// Initialize the video support
new LearnDash_Custom_Video_Support();

/**
 * Helper function to manually get video content for a lesson/topic
 * 
 * @param int|WP_Post $post_id The lesson/topic post ID or object
 * @return string Video HTML content or empty string
 */
function learndash_get_video_content($post_id = null) {
    if (empty($post_id)) {
        global $post;
        $post_id = $post;
    }
    
    if (is_numeric($post_id)) {
        $post_obj = get_post($post_id);
    } else {
        $post_obj = $post_id;
    }
    
    if (!$post_obj || !in_array($post_obj->post_type, array('sfwd-lessons', 'sfwd-topic'))) {
        return '';
    }
    
    // Check if LearnDash video is enabled
    if (!defined('LEARNDASH_LESSON_VIDEO') || !LEARNDASH_LESSON_VIDEO) {
        return '';
    }
    
    // Get lesson/topic settings
    $step_settings = learndash_get_setting($post_obj);
    
    // Check if video is enabled and has URL
    if (empty($step_settings['lesson_video_enabled']) || 
        $step_settings['lesson_video_enabled'] !== 'on' ||
        empty($step_settings['lesson_video_url'])) {
        return '';
    }
    
    // Get video instance
    if (!class_exists('Learndash_Course_Video')) {
        return '';
    }
    
    $ld_course_videos = Learndash_Course_Video::get_instance();
    
    // Get course and user info
    $course_id = learndash_get_course_id($post_obj);
    $user_id = get_current_user_id();
    
    // Process video content
    $video_content = $ld_course_videos->add_video_to_content('', $post_obj, $step_settings);
    
    return $video_content;
}

/**
 * Helper function to check if a lesson/topic has video
 * 
 * @param int|WP_Post $post_id The lesson/topic post ID or object
 * @return bool True if has video, false otherwise
 */
function learndash_has_video($post_id = null) {
    if (empty($post_id)) {
        global $post;
        $post_id = $post;
    }
    
    if (is_numeric($post_id)) {
        $post_obj = get_post($post_id);
    } else {
        $post_obj = $post_id;
    }
    
    if (!$post_obj || !in_array($post_obj->post_type, array('sfwd-lessons', 'sfwd-topic'))) {
        return false;
    }
    
    // Check if LearnDash video is enabled
    if (!defined('LEARNDASH_LESSON_VIDEO') || !LEARNDASH_LESSON_VIDEO) {
        return false;
    }
    
    // Get lesson/topic settings
    $step_settings = learndash_get_setting($post_obj);
    
    // Check if video is enabled and has URL
    return !empty($step_settings['lesson_video_enabled']) && 
           $step_settings['lesson_video_enabled'] === 'on' &&
           !empty($step_settings['lesson_video_url']);
}
